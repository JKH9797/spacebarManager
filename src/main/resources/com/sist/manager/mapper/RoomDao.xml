<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sist.manager.dao.RoomDao">
	
	<resultMap type="com.sist.manager.model.Room" id="roomResultMap">
		<id column="ROOM_SEQ" property="roomSeq" />
		<result column="ROOM_CAT_SEQ" property="roomCatSeq" />
		<result column="HOST_ID" property="hostId" />
		<result column="ROOM_ADDR" property="roomAddr" />
		<result column="LATITUDE" property="latitude" />
		<result column="LONGITUDE" property="longitude" />
		<result column="REGION" property="region" />
		<result column="REG_DT" property="regDt" />
		<result column="UPDATE_DT" property="updateDt" />
		<result column="AUTO_CONFIRM_YN" property="autoConfirmYn" />
		<result column="ROOM_TITLE" property="roomTitle" />
		<result column="ROOM_DESC" property="roomDesc" />
		<result column="CANCEL_POLICY" property="cancelPolicy" />
		<result column="AVERAGE_RATING" property="averageRating" />
		<result column="REVIEW_COUNT" property="reviewCount" />
		<result column="MIN_TIMES" property="minTimes" />
		<result column="MAX_TIMES" property="maxTimes" />
		<result column="DEL_YN" property="delYn" />
		<result column="SALE_YN" property="saleYn" />
		<result column="ROOM_CAT_NAME" property="roomCatName" />		
	</resultMap>
	
	<!-- 룸리스트 -->
	<select id="roomList"
          parameterType="com.sist.manager.model.Room"
          resultMap="roomResultMap">
    SELECT
      ROOM_SEQ,
      ROOM_CAT_SEQ,
      HOST_ID,
      ROOM_ADDR,
      LATITUDE,
      LONGITUDE,
      REGION,
      REG_DT,
      UPDATE_DT,
      AUTO_CONFIRM_YN,
      ROOM_TITLE,
      ROOM_DESC,
      CANCEL_POLICY,
      AVERAGE_RATING,
      REVIEW_COUNT,
      MIN_TIMES,
      MAX_TIMES,
      DEL_YN,
      SALE_YN,
      ROOM_CAT_NAME
    FROM (
      SELECT ROWNUM AS RNUM,
             ROOM_SEQ,
             ROOM_CAT_SEQ,
             HOST_ID,
             ROOM_ADDR,
             LATITUDE,
             LONGITUDE,
             REGION,
             REG_DT,
             UPDATE_DT,
             AUTO_CONFIRM_YN,
             ROOM_TITLE,
             ROOM_DESC,
             CANCEL_POLICY,
             AVERAGE_RATING,
             REVIEW_COUNT,
             MIN_TIMES,
             MAX_TIMES,
             DEL_YN,
             SALE_YN,
             ROOM_CAT_NAME
      FROM (
        SELECT
          A.ROOM_SEQ ROOM_SEQ,
          A.ROOM_CAT_SEQ ROOM_CAT_SEQ,
          A.HOST_ID HOST_ID,
          A.ROOM_ADDR ROOM_ADDR,
          A.LATITUDE LATITUDE,
          A.LONGITUDE LONGITUDE,
          A.REGION REGION,
          A.REG_DT REG_DT,
          A.UPDATE_DT UPDATE_DT,
          A.AUTO_CONFIRM_YN AUTO_CONFIRM_YN,
          A.ROOM_TITLE ROOM_TITLE,
          A.ROOM_DESC ROOM_DESC,
          A.CANCEL_POLICY CANCEL_POLICY,
          A.AVERAGE_RATING AVERAGE_RATING,
          A.REVIEW_COUNT REVIEW_COUNT,
          A.MIN_TIMES MIN_TIMES,
          A.MAX_TIMES MAX_TIMES,
          A.DEL_YN DEL_YN,
          A.SALE_YN SALE_YN,
          B.ROOM_CAT_NAME ROOM_CAT_NAME
        FROM ROOM A, ROOM_CATEGORY B
        WHERE A.ROOM_CAT_SEQ = B.ROOM_CAT_SEQ
        <if test="roomCatName != null and roomCatName != ''">
          AND ROOM_CAT_NAME LIKE '%' || #{roomCatName} || '%'
        </if>
        <if test="hostId != null and hostId != ''">
          AND HOST_ID LIKE '%' || #{hostId} || '%'
        </if>
        <if test="region != null and region != ''">
          AND REGION LIKE '%' || #{region} || '%'
        </if>
        <if test="roomTitle != null and roomTitle != ''">
          AND ROOM_TITLE LIKE '%' || #{"roomTitle"} || '%'
        </if>
        <if test="delYn != null and delYn != ''">
          AND DEL_YN = #{delYn}
        </if>
        <if test="saleYn != null and saleYn != ''">
          AND SALE_YN = #{saleYn}
        </if>
        ORDER BY REG_DT DESC
      )
    )
    WHERE RNUM <![CDATA[>=]]> #{startRow}
      AND RNUM <![CDATA[<=]]> #{endRow}
  </select>
  
    <!-- 전체 건수 조회 -->
  <select id="roomListCount"
          parameterType="com.sist.manager.model.Room"
          resultType="int">
    SELECT COUNT(ROOM_SEQ) CNT
      FROM ROOM A, ROOM_CATEGORY B
     WHERE A.ROOM_CAT_SEQ = B.ROOM_CAT_SEQ
       <if test="roomCatName != null and roomCatName != ''">
          AND ROOM_CAT_NAME LIKE '%' || #{roomCatName} || '%'
        </if>
        <if test="hostId != null and hostId != ''">
          AND HOST_ID LIKE '%' || #{hostId} || '%'
        </if>
        <if test="region != null and region != ''">
          AND REGION LIKE '%' || #{region} || '%'
        </if>
        <if test="roomTitle != null and roomTitle != ''">
          AND ROOM_TITLE LIKE '%' || #{"roomTitle"} || '%'
        </if>
        <if test="delYn != null and delYn != ''">
          AND DEL_YN = #{delYn}
        </if>
        <if test="saleYn != null and saleYn != ''">
          AND SALE_YN = #{saleYn}
        </if>
  </select>
	
	
	<!-- 삭제여부 토글 -->
	<update id="toggleDelete" parameterType="long">
	   UPDATE ROOM
		  SET 
		    DEL_YN = CASE
		      WHEN DEL_YN = 'N' THEN 'Y'
		      ELSE 'N'
		    END,
		    SALE_YN = CASE 
		      WHEN DEL_YN = 'N' THEN 'N'
		      ELSE 'Y'
		    END
		  WHERE ROOM_SEQ = #{roomSeq}
	</update>
	
	<!-- 판매상태 토글 -->
	<update id="toggleSale" parameterType="long">
	  UPDATE ROOM
	  SET SALE_YN = CASE
	      WHEN SALE_YN = 'Y' THEN 'N'
	      ELSE 'Y'
	    END
	  WHERE ROOM_SEQ = #{roomSeq}
	</update>

</mapper>
